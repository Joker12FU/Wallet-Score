<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Wallet Score</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --bg: #0f1724;
        --card: #0b1220;
        --muted: #93b3c4;
        --accent: #06b6d4;
      }
      body {
        font-family: Inter, system-ui, Segoe UI, Arial;
        margin: 0;
        padding: 20px;
        background: var(--bg);
        color: #e6eef8;
      }
      .card {
        background: var(--card);
        padding: 24px;
        border-radius: 12px;
        max-width: 900px;
        margin: 20px auto;
        box-shadow: 0 6px 18px rgba(2, 6, 23, 0.6);
      }
      input,
      select {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #21303f;
        background: #071121;
        color: #e6eef8;
        margin-bottom: 12px;
        font-size: 15px;
      }
      button {
        padding: 12px 16px;
        border-radius: 8px;
        border: 0;
        background: var(--accent);
        color: #012;
        cursor: pointer;
        font-weight: 700;
      }
      .result {
        margin-top: 14px;
        padding: 12px;
        border-radius: 8px;
        background: #071827;
      }
      .label {
        display: inline-block;
        padding: 6px 10px;
        border-radius: 999px;
        background: #052d32;
        color: #dff7f8;
        font-weight: 700;
      }
      pre {
        white-space: pre-wrap;
        color: #cfecef;
        font-size: 13px;
        overflow: auto;
        max-height: 320px;
      }
      h1 {
        margin: 0 0 8px 0;
      }
      .small {
        color: var(--muted);
        font-size: 13px;
      }
      .row {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .spinner {
        border: 4px solid #21303f;
        border-top: 4px solid var(--accent);
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 8px;
        vertical-align: middle;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      canvas {
        margin-top: 20px;
        max-height: 300px;
      }
      @media (max-width: 640px) {
        .row { flex-direction: column; }
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Wallet Score</h1>
      <p class="small">
        Enter a wallet address (EVM or Solana) and click
        <strong>Scan Wallet (Live)</strong>.
      </p>

      <input id="address" placeholder="0x1234... or Solana address" />
      <div class="row">
        <select id="chain" aria-label="chain select">
          <option value="ethereum">Ethereum / EVM</option>
          <option value="solana">Solana</option>
        </select>
        <button id="scanBtn">Scan Wallet (Live)</button>
      </div>

      <div id="status" class="result" style="display: none"></div>
      <canvas id="chart" style="display: none;"></canvas>
      <div id="raw" style="margin-top: 12px"></div>
    </div>

    <script>
      const scanBtn = document.getElementById("scanBtn");
      const addressEl = document.getElementById("address");
      const chainEl = document.getElementById("chain");
      const status = document.getElementById("status");
      const raw = document.getElementById("raw");
      const chartEl = document.getElementById("chart");
      let chart; // global chart instance

      scanBtn.onclick = async () => {
        const address = addressEl.value.trim();
        const chain = chainEl.value;
        if (!address) return alert("Enter an address");

        status.style.display = "block";
        status.innerHTML = '<span class="spinner"></span> Scanning…';
        raw.innerHTML = "";
        chartEl.style.display = "none";

        try {
          const r = await fetch("/api/scan", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ address, chain }),
          });

          const j = await r.json();
          if (!r.ok) {
            status.innerHTML = "Error: " + (j.error || JSON.stringify(j));
            return;
          }

          status.innerHTML = `
            <strong>Score: ${j.score.toFixed(2)}/100</strong> 
            · <span class="label">${j.labels.join(", ")}</span>
          `;

          // Display raw details
          raw.innerHTML = "<pre>" + JSON.stringify(j.details, null, 2) + "</pre>";

          // Generate live chart
          if (j.labels.includes("EVM") && j.details.items) {
            const tokens = j.details.items
              .filter((t) => t.balance > 0)
              .slice(0, 5);
            const labels = tokens.map((t) => t.contract_ticker_symbol || "Token");
            const data = tokens.map((t) => Number(t.balance) / 1e18);

            if (chart) chart.destroy();
            chart = new Chart(chartEl, {
              type: "doughnut",
              data: {
                labels,
                datasets: [
                  {
                    data,
                    backgroundColor: ["#06b6d4", "#fbbf24", "#22c55e", "#ef4444", "#8b5cf6"],
                  },
                ],
              },
              options: {
                plugins: {
                  legend: { labels: { color: "#e6eef8" } },
                },
              },
            });
            chartEl.style.display = "block";
          } else if (j.labels.includes("Solana")) {
            if (chart) chart.destroy();
            chart = new Chart(chartEl, {
              type: "bar",
              data: {
                labels: ["Balance"],
                datasets: [
                  {
                    label: "SOL",
                    data: [j.details.balance || 0],
                    backgroundColor: "#06b6d4",
                  },
                ],
              },
              options: {
                scales: {
                  x: { ticks: { color: "#e6eef8" } },
                  y: { ticks: { color: "#e6eef8" } },
                },
                plugins: {
                  legend: { labels: { color: "#e6eef8" } },
                },
              },
            });
            chartEl.style.display = "block";
          }
        } catch (e) {
          status.innerHTML = "Network error: " + e.message;
        }
      };
    </script>
  </body>
</html>
